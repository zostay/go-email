package transfer_test

import (
	"bytes"
	"io"
	"os"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/zostay/go-email/v2/message/transfer"
)

const attGifBase64 = `R0lGODlhDAAMAPcAAAAAAAgICBAQEBgYGCkpKTExMTk5OUpKSoyMjJSUlJycnKWlpbW1tc7Ozufn
5+/v7/f39///////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////ywAAAAADAAMAAAIXwAjRICQ
wIAAAQYUQBAYwUEBAAACEIBYwMHAhxARNIAIoAAEBBAPOICwkSMCjBAXlKQYgCMABSsjtuQI02UA
lC9jFgBJMyYCCCgRMODoseFElx0tCvxYIEAAAwkWRggIADs=`

func TestNewBase64Decoder(t *testing.T) {
	t.Parallel()

	r := strings.NewReader(attGifBase64)
	dr := transfer.NewBase64Decoder(r)
	bin, err := io.ReadAll(dr)
	assert.NoError(t, err)

	binExpected, err := os.ReadFile("../../test/data/att-1.gif")
	assert.NoError(t, err)

	assert.NoError(t, err)
	assert.Equal(t, binExpected, bin)
}

func TestNewBase64Encoder(t *testing.T) {
	t.Parallel()

	w := &bytes.Buffer{}
	dw := transfer.NewBase64Encoder(w)

	binInput, err := os.ReadFile("../../test/data/att-1.gif")
	assert.NoError(t, err)
	assert.Len(t, binInput, 890)

	n, err := dw.Write(binInput)
	assert.Equal(t, 890, n)
	assert.NoError(t, err)

	err = dw.Close()
	assert.NoError(t, err)

	assert.Equal(t, []byte(attGifBase64), w.Bytes())
}
